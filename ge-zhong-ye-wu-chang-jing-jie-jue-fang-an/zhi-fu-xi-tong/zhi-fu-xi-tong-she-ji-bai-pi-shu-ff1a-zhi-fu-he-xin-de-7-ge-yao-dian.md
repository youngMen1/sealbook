# 1.支付系统设计白皮书：支付核心的 7 个要点

## 1.1.支付前置

着业务定制化对交易支付需求复杂度的增加，交易系统保证系统稳定的同时，亦需灵活性以支持业务。但系统设计时，灵活和稳定是矛盾的，稳定意味着剥离变化，灵活意味着可配置化。

支付前置的职责即：解决支持业务变化的扩展性，将交易通过支付前置的配置转化为后端支付系统能统一处理的模式，方便后端多样化的记账需求。

### 支付前置的定义

* 支付前置包装后端支付核心系统的接口，包装后对外提供的服务包括余额、 现金、网银、快捷支付、出款及相关订单的退款和控制接口；另提供后台系统调用的服务包括确定性入款、登账、冻结解冻、退票等，所有的支付行为都会以业务支付订单的形式落地；
* 用户在前端发起一次支付行为后，交易系统基于原始的交易订单，对应生成一条付款订单，通过这笔付款订单和支付核心进行交互。

### 业务产品码：

交易系统各类交易接口包装成业务产品（提现、充值等）后，将对应的支付请求发送到支付前置系统，前置系统根据业务产品编码和本身的支付业务配置关系，生成对应的业务支付订单并处理后续流程。

### 支付产品码：

由于即时到账、担保交易在业务规则上不同，但支付渠道侧判断均为支付，因此支付产品码相同，但业务产品码不同。这里的支付产品编码配置来自于支付协议的配置，一个支付产品编码代表着一个支付协议。


## 1.2.支付协议

TODO 


## 1.3.支付引擎

### 支付引擎的类型
定义支付的原子级支付形态，所有的支付行为都是账户资金的流转，可梳理出以下几个支付类型：

* 充值：资金从外部资金源向内部资金源转移的支付动作；
* 提现：资金从内部向外部资金源转移的支付动作；
* 内转支付（转账）：资金在内部账户转移的支付动作，这里的定义和产品中定义的转账概念不同；
* 退款：充值的反向操作。

### 指令

指令即支付核心的工单号，前置的每笔支付订单对应着一笔甚至多笔指令。指令里包含了这笔支付订单是原始支付类型（充值、提现、转账、退款，指令一定是基于原始支付类型来生成的，任何支付行为都能被原子类型所支持），对应着的业务请求类型、支付方式、支付产品编码、参与方信息（交易中收付款人的信息）、相关联的支付指令信息（退款时用于关联原支付指令）、支付服务流程等相关信息；由支付指令去调用支付服务流程时，再根据流程编排环节去确定何时生成账务类操作指令和清算类操作指令。

举例：用户在电商网站购买一本书价格 100 元，通过支付宝付款，交易类型为担保交易，在交易核心生成一笔担保支付的订单，调用支付核心系统时支付系统判断该业务调用方对应已经配置了「收单支付协议」，且根据对应协议生成一笔业务类型为第三方支付的支付订单，基于此订单生成了第一条充值的支付指令。

该指令在根据支付类型去调用服务流程时，先通过流程编排生成清算指令并调用（这里值得注意的是，先生成清算指令的原因在于需要先调用外部支付渠道，把钱收进来），用户付款成功后再生成账务指令并调用账务核心，执行内部账务入账。

### 服务流程
定义支付指令的执行流程，将支付拆分成原子级支付类型，并对支付类型的流程进行编排，任何一个交易的请求，都能被上述四种基础支付类型组合进而完成支付行为。

例如：一笔担保收单的交易，用户用支付宝等第三方支付完成了这笔交易，并在 7 天后确认收货，平台侧 7 天后根据用户的行为应该将该笔货款打给了商户。

这里我们将用户的行为分为**支付**和**确认收货**两个动作，对应着在交易侧这也是两次请求，一次支付，一次结算：

* 在支付层对应收单支付协议；
* 在前置系统被拆分成了两笔业务支付订单，一笔是快捷支付（业务类型，类型自定义，可以叫第三方支付），一笔是余额转账（将资金从担保账户结算到商家账户）；

而后分别生成两条支付指令（充值和转账），充值代表着用户的支行为，转账代表着用户的确认收货行为，因为从但保护结算到商家账户，可以定义为这是一笔账户之间的资金扭转。


# 2.参考
http://www.woshipm.com/pd/2175375.html



