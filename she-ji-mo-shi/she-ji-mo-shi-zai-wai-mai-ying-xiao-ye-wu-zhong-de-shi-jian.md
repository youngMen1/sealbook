# 1.设计模式在外卖营销业务中的具体案例

## 1.1.**“邀请下单”业务中设计模式的实践**

### 1.1.1.**业务简介**

“邀请下单”是美团外卖用户邀请其他用户下单后给予奖励的平台。即用户A邀请用户B，并且用户B在美团下单后，给予用户A一定的现金奖励（以下简称返奖）。同时为了协调成本与收益的关系，返奖会有多个计算策略。邀请下单后台主要涉及两个技术要点：

* 返奖金额的计算，涉及到不同的计算规则。

* 从邀请开始到返奖结束的整个流程。

![img](/static/image/1.jpg)

### 1.1.2.返奖规则与设计模式实践

**业务建模**

如图是返奖规则计算的业务逻辑视图：

![img](/static/image/2.png)

从这份业务逻辑图中可以看到返奖金额计算的规则。首先要根据用户状态确定用户是否满足返奖条件。如果满足返奖条件，则继续判断当前用户属于新用户还是老用户，从而给予不同的奖励方案。一共涉及以下几种不同的奖励方案：

**新用户**

* 普通奖励（给予固定金额的奖励）

* 梯度奖（根据用户邀请的人数给予不同的奖励金额，邀请的人越多，奖励金额越多）

**老用户**

* 根据老用户的用户属性来计算返奖金额。为了评估不同的邀新效果，老用户返奖会存在多种返奖机制。
计算完奖励金额以后，还需要更新用户的奖金信息，以及通知结算服务对用户的金额进行结算。这两个模块对于所有的奖励来说都是一样的。

可以看到，无论是何种用户，对于整体返奖流程是不变的，唯一变化的是返奖规则。此处，我们可参考**开闭原则**，对于返奖流程保持封闭，对于可能扩展的返奖规则进行开放。我们将返奖规则抽象为**返奖策略**，即针对不同用户类型的不同返奖方案，我们视为不同的**返奖策略**，不同的返奖策略会产生不同的返奖金额结果。

在我们的领域模型里，返奖策略是一个**值对象**，我们通过工厂的方式生产针对不同用户的奖励策略值对象。下文我们将介绍以上领域模型的工程实现，即**工厂模式**和**策略模式**的实际应用。

#### 模式：工厂模式
工厂模式又细分为工厂方法模式和抽象工厂模式，本文主要介绍工厂方法模式。
**模式定义：**定义一个用于创建对象的接口，让子类决定实例化哪一个类。工厂方法是一个类的实例化延迟到其子类。
#### 模式：策略模式

# 2.怎么使用

# 3.总结

# 4.参考

[https://zyl.me/blog/2162](https://zyl.me/blog/2162)

