## 1.分布式系统CAP理论

CAP理论：一个分布式系统最多只能同时满足一致性（Consistency）、可用性（Availability）和分区容错性（Partition tolerance）这三项中的两项。

**1.1.Consistency 一致性（涉及重要信息如钱财；分布式存储系统必须保证）**

从客户端角度，多进程并发访问时，更新过的数据在不同进程如何获取的不同策略，决定了不同的一致性:

1.强一致性:对于关系型数据库，要求更新过的数据能被后续的访问都能看到.

2.弱一致性：能容忍后续的部分或者全部访问不到。

3.最终一致性：经过一段时间后要求能访问到更新后的数据。

CAP中说，不可能同时满足的这个一致性指的是强一致性。

**1.2.Availability 可用性（大型互联网为了服务可用，舍弃强一致性，保证最终一致性）**

服务一直可用，而且是正常响应时间。

| 可用性分类 | 可用水平（%） | 年可容忍停机时间 |
| :--- | :--- | :--- |
| 容错可用性 | 99.9999 | &lt;1 min |
| 极高可用性 | 99.999 | &lt;5 min |
| 具有故障自动恢复能力的可用性 | 99.99 | &lt;53 min |
| 高可用性 | 99.9 | &lt;8.8h |
| 商品可用性 | 99 | &lt;43.8 min |

**1.3.Partition Tolerance分区容错性\(分布式必须要考虑的问题）**

分布式系统在遇到某节点或网络故障的时候，仍然能够对外提供满足一致性和可用性的服务。就是在网络中断的情况下，系统如果还能正常工作。

作为一个分布式系统，它和单机系统的最大区别，就在于网络.

现在假设一种极端情况，N1和N2之间的网络断开了:

![img](/static/image/1534597032402489.png)

假设N1和N2之间网络断开，由于网络是断开的，所以N2中的数据依旧是V0.

这时有用户向N2发送数据读取请求，

第一，牺牲数据一致性，保证可用性。响应旧的数据V0给用户；

第二，牺牲可用性，保证数据一致性。阻塞等待，直到网络连接恢复，数据更新操作M完成之后，再给用户响应最新的数据V1。

**CA\(一致性+可用性）without P（容错性）**

```
单机的Mysql和Oracle；

分布式集群中不存在这种情况，因为多个节点必定考虑主备同步，也就是网络。
```

**CP\(一致性+容错性）without A（可用性）**

```
分布式的数据库，如Redis，HBase，Zookeeper

任何时刻对ZooKeeper请求能得到一致的数据结果:当master节点网络故障，会进行选举机制，
```

选举时集群不可用。但是它不能保证每次服务请求的可用性，ZooKeeper可能会丢弃一些请求，消费者程序需要重新请求才能获得结果。

**AP\(可用性+容错性）without C（一致性）**

```
12306买票

购买的时候提示你是有票的（但是可能实际已经没票了），但是过了一会系统提示你下单失败，余票不足。
```

其实舍弃的只是强一致性。退而求其次保证了最终一致性。

```
Eureka

各个节点平等；有节点挂掉，会立刻换至其他节点，保证服务可用，只不过查到的信息可能不是最新的。在网络稳定后，
当前实例新的注册信息会被同步到其他节点中。
```

一旦网络问题发生，节点之间可能会失去联系。为了保证高可用，需要在用户访问时可以马上得到返回，导致全局数据的不一致性。

**再来了解一个概念BASE理论，BASE理论是CAP理论的一种实现，它对分布式系统的一致性和可用性不可兼得的问题提出了一种方案，即基本可用和最终一致是目标。既然提到了强一致性和最终一致性，再介绍一下业界对一致性的分层次定义。**

* **强一致 ：**当更新操作完成之后，任何多个后续进程或者线程的访问都会返回最新的更新过的值。这种是对用户最友好的，就是用户上一次写什么，下一次就保证能读到什么。根据 CAP 理论，这种实现需要牺牲可用性。

* **弱一致 **：系统并不保证续进程或者线程的访问都会返回最新的更新过的值。系统在数据写入成功之后，不承诺立即可以读到最新写入的值，也不会具体的承诺多久之后可以读到。

* **最终一致 **：弱一致性的特定形式。系统保证在没有后续更新的前提下，系统最终返回上一次更新操作的值。在没有故障发生的前提下，不一致窗口的时间主要受通信延迟，系统负载和复制副本的个数影响。DNS 是一个典型的最终一致性系统。

对上面几段分析的总结就是：关系型数据库的事务可以满足单系统的强一致性，大部分分布式系统只能把最终一致性作为追求。而我们的deco和poi系统显然也是应该追求最终一致性，因为对于poi和deco之间装修审核数据出现短时间的不一致是完全可以接受的。




