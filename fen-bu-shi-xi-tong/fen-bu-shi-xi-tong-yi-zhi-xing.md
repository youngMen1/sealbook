# 1.基本介绍

**业务背景**：

商户提交表单数据至旺铺（deco项目，以下皆称为deco），deco需要接入poi系统进行装修内容的人工审核，详细流程见下图。

**使用实例：**做流程引擎的时候员工开单后需要审批通过后才能开单成功\(**最终一致性**\)

### **问题**：

店铺装修审核状态在deco系统和poi系统之间不一致，下图中1，2，3步提交流程会出现同一次提交审核流在deco系统中的装修状态为未装修，而在poi系统为审核中。同样在4，5，6步骤的审核回调过程也会有同类的状态不一致问题。两块问题都是同一技术问题，本文只以1，2，3步提交过程为例进行分析解决。

![img](/static/image/1305952-20180528103811932-766030002.jpg)

## 1.1.问题分析

### 1.1.1.关系型数据事务在分布式系统中的问题
从业务中抽离出来，问题的核心原因可用下图流程模型来描述。
![img](/static/image/1305952-20180528103852437-1819386895.jpg)

**系统A的某个业务功能包含两步操作：**
第一步把数据写入A系统本地库，
第二步远程调用系统B，
这两步操作在A系统用一个数据库事务来包装。
伪代码如下：

```
$db->begain();
// 第一步操作本地数据库
$res = $db->update($sql_a);
if (!$res) {
    $db->rollback();
    return;
}
// 第二步远程调用B系统
$res = $http_request->get($url_b);
if ('success' != $res) {
    $db->rollback();
    return;
}
$db->commit();
```
**第一步有两种结果成功、失败，**
**第二步则有3种结果成功、失败、超时，**
其中导致超时原因可能是网络中断，也可能是B系统服务异常。
那么我们根据两步骤的执行结果情况来分别分析一下是否会导致A、B系统之间的数据不一致。





# 2.怎么使用

# 3.总结

# 4.参考



