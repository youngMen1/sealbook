# 1.基本介绍

## CAP定理

### C（一致性）：所有的节点上的数据时刻保持同步，对于事务只能同时的成功或者失败，即所有的备份数据已经完全和主数据完全一致。

* 强一致性：这种一致性级别是最符合用户直觉的，它要求系统写入什么，读出来的也会是什么，用户体验好，但实现起来往往对系统的性能影响大。对于每个事务在提交后，只能出现成功或者失败两种状态，不存在中间状态。

* 弱一致性：这种一致性级别约束了系统在写入成功后，不承诺立即可以读到写入的值，也不久承诺多久之后数据能够达到一致，但会尽可能地保证到某个时间级别（比如秒级别）后，数据能够达到一致状态。

* 最终一致性：最终一致性是弱一致性的一个特例，系统会保证在一定时间内，能够达到一个数据一致的状态。这里之所以将最终一致性单独提出来，是因为它是弱一致性中非常推崇的一种一致性模型，也是业界在大型分布式系统的数据一致性上比较推崇的模型。

* 顺序一致性：是指每个提交的事务会根据提交的顺序，使得系统的数据达到最终一致性状态。但是我们知道分布式系统是没有全局时钟的概念，因此在度量分布式事务的顺序时是不准确的，因此顺序一致性大部分是指同一节点提交事务的顺序，不是不同节点之间的顺序性。其中顺序最终一致性常用于redis等分布式数据库系统中。

### A（可用性）：每个请求都能在指定时间内接受到一个准确的响应（成功或者失败）。然而在分布式系统中还会出现超时这样一种不确定的状态。

在分布式系统中通信异常时最常见的一种异常，其是不可避免的，因此在一个请求发生时，如果发生通信异常，就会产生如下两种情况：1）请求没有到达目标系统，造成整个请求超时（请求未处理）。2）请求到达目标系统，但是在目标返回响应的过程中，响应信息丢失，造成整个请求超时（请求已经处理）。因此超时对于客户系统而言都是一种不确定的状态，其服务是不可用的状态。对于一个分布式系统假设每个机器或者节点产生网络故障的概率是P，那么整个分布式系统的极致可用性是1-P^N（N表示机器或者节点数量）。因此此处所说的可用性是指分布式系统的极致可用性，即只要有一台机器或者节点可用那么就要保证整个服务可用。

### P（分区容错性）：系统应该能持续提供服务，即使由于网络原因造成系统被分隔成很多个子系统（分区），任然能够提供服务。

网络问题是分布式系统不可避免的问题，并且是一定会发生的问题。因此对于分布式系统必须要具有分区容错性。例如：一个分布式系统需要有3个备份，其分区容错性为2，及要求必须有2个备份才能继续提供服务。因此如果其中一个备份的机器节点不可达，由于分区容错性的存在，其可以继续提供服务，并且分布式系统会根据情况等待该分区重新连接，恢复失去连接时的新增数据，之后再提供服务。或者由于节点宕机，会重新产生一个分区，并同步所有的数据（时间较长），等数据同步完成再开始进行服务。如果一个分布式系统不允许分区容错性，那么只要一个备份数据不可用，整个服务都不可用，这是用户不可接受的。

# 2.怎么使用

## 2.1.**分布式系统在CAP中的选型** {#3-分布式系统在cap中的选型}

### 2.1.1.**CA类型系统** {#31-ca类型系统}

单机数据库（CA类型）：由于数据库的是以事务为单位进行执行的而事务具有ACID的特性，因此能够保证数据时刻都是同步的。并且只要整个网络不瘫痪（及单机数据库不宕机）都能保证服务是可用的。因此单机数据库系统是具有CA特性的。

在数据库中主要是通过记录log日志（redo日志和undo日志）来保证数据的一致性。通过乐观锁（快照读，根据事务的不同执行时间，提供不同版本的快照数据，达到读不加锁，提高服务的可用性），对于需要加锁悲观锁的操作（update delete alter select for update\)通过当前读及对要处理的记录加锁\(gap锁\)来使得整个操作串行化的目的。

### 2.1.2.**CP类型系统（分布式数据库）**

**分布式数据库（半同步复制\)**：

主从同步延迟引起的数据不一致，可以通过消除主从延迟或者对有延迟的数据读主库来达到数据的强一致性。

**半同步复制**：

在客户端请求时，等从库同步完成后，再返回。
![img](/static/image/20170418234317382.jpg)
方案优点：利用数据库原生功能，比较简单 
方案缺点：主库的写请求时延会增长，吞吐量会降低。极端情况下，网络分区的出现，造成整个服务不可用。


分布式数据库（数据库中间件）：由中间件根据主从同步的完成情况来决定是查主库还是从库。 

# 3.参考

**分布式系统的基本问题：可用性与一致性**

[https://mp.weixin.qq.com/s?\_\_biz=MzIzOTU0NTQ0MA==∣=2247488548&idx=1&sn=3414db5583fc4f42a99a725423e841ff&chksm=e929292bde5ea03d17c45aa5c4d4b86a9e295c80674a17bb34a131116e5741b5d21541fb039f&mpshare=1&scene=23&srcid=10263r8WpzpkOymERUMdNo6t\#rd](https://mp.weixin.qq.com/s?__biz=MzIzOTU0NTQ0MA==&mid=2247488548&idx=1&sn=3414db5583fc4f42a99a725423e841ff&chksm=e929292bde5ea03d17c45aa5c4d4b86a9e295c80674a17bb34a131116e5741b5d21541fb039f&mpshare=1&scene=23&srcid=10263r8WpzpkOymERUMdNo6t#rd)

**分布式中间件系统的一致性和可用性：**

[https://blog.csdn.net/CWeeYii/article/details/70233933](https://blog.csdn.net/CWeeYii/article/details/70233933)

